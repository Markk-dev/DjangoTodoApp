{% extends "base.html" %}
{% load static %}
{% block title %}Todo App{% endblock %}
{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">

<div class="todo-container">
    <form method="POST" action="{% url 'add_todo' %}" class="add-form">
        {% csrf_token %}
        <input type="text" name="title" class="add-input" placeholder="Add a new task" required>
        <textarea name="description" class="add-textarea" placeholder="Add description (optional)" rows="2"></textarea>
    </form>
    
    <div class="filter-bar">
        <div class="filters">
            <button class="filter-btn active" onclick="filterTodos('all')">All</button>
            <button class="filter-btn" onclick="filterTodos('pending')">Pending</button>
            <button class="filter-btn" onclick="filterTodos('completed')">Completed</button>
        </div>
        {% if todos.paginator.count > 0 %}
        <form method="POST" action="{% url 'clear_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="clear-btn">Clear All</button>
        </form>
        {% endif %}
    </div>
    
    <div class="todo-list">
        {% for todo in todos %}
        <div class="todo-item {% if todo.completed %}completed{% endif %}" data-status="{% if todo.completed %}completed{% else %}pending{% endif %}">
            <input type="checkbox" class="todo-checkbox" {% if todo.completed %}checked{% endif %} onchange="toggleTodo({{ todo.id }})">
            <div class="todo-content">
                <div class="todo-title">{{ todo.title }}</div>
                {% if todo.description %}
                <div class="todo-description">{{ todo.description }}</div>
                {% endif %}
            </div>
            <div class="todo-menu">
                <button class="menu-btn" onclick="toggleMenu({{ todo.id }})">â‹¯</button>
                <div class="menu-dropdown" id="menu-{{ todo.id }}">
                    <button onclick="openEditModal({{ todo.id }}, '{{ todo.title|escapejs }}')">Edit</button>
                    <button onclick="openDeleteModal({{ todo.id }})">Delete</button>
                </div>
            </div>
        </div>
        {% empty %}
        <p style="text-align: center; color: #999; padding: 40px 0;">No todos yet. Add one above!</p>
        {% endfor %}
    </div>
    
    {% if todos.paginator.count > 5 %}
    <div class="pagination">
        {% if todos.has_previous %}
        <a href="?page={{ todos.previous_page_number }}"><button>Previous</button></a>
        {% else %}
        <button disabled>Previous</button>
        {% endif %}
        
        <span>Page {{ todos.number }} of {{ todos.paginator.num_pages }}</span>
        
        {% if todos.has_next %}
        <a href="?page={{ todos.next_page_number }}"><button>Next</button></a>
        {% else %}
        <button disabled>Next</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="edit-modal" id="editModal">
    <div class="modal-content">
        <h3>Edit Task</h3>
        <form method="POST" id="editForm">
            {% csrf_token %}
            <input type="text" name="title" id="editInput" required>
            <textarea name="description" id="editDescription" placeholder="Description (optional)" rows="3"></textarea>
            <div class="modal-buttons">
                <button type="submit" class="btn-primary">Save</button>
                <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="delete-modal" id="deleteModal">
    <div class="modal-content">
        <h3>Delete Task</h3>
        <p>Are you sure you want to delete this task?</p>
        <form method="POST" id="deleteForm">
            {% csrf_token %}
            <div class="modal-buttons">
                <button type="submit" class="btn-danger">Delete</button>
                <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleMenu(id) {
        document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('active'));
        document.getElementById('menu-' + id).classList.toggle('active');
    }
    
    function toggleTodo(id) {
        fetch('/toggle/' + id + '/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
            .then(() => location.reload());
    }
    
    function openEditModal(id, title) {
        document.getElementById('editInput').value = title;
        document.getElementById('editForm').action = '/edit/' + id + '/';
        document.getElementById('editModal').classList.add('active');
        
        fetch('/get-description/' + id + '/')
            .then(res => res.json())
            .then(data => {
                document.getElementById('editDescription').value = data.description || '';
            });
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
    }
    
    function openDeleteModal(id) {
        document.getElementById('deleteForm').action = '/delete/' + id + '/';
        document.getElementById('deleteModal').classList.add('active');
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
    }
    
    function filterTodos(filter) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('.todo-item').forEach(item => {
            if (filter === 'all') item.style.display = 'flex';
            else if (filter === item.dataset.status) item.style.display = 'flex';
            else item.style.display = 'none';
        });
    }
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.todo-menu')) {
            document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('active'));
        }
    });
</script>
{% endblock %}